"use strict";(self.webpackChunkanalytic_project=self.webpackChunkanalytic_project||[]).push([[1077],{8736:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>c,toc:()=>s});var t=r(4848),i=r(8453);const l={title:"ThreadPoolExecutor",sidebar_position:6,toc_min_heading_level:2,toc_max_heading_level:5},o=void 0,c={id:"JavaDocs/JUC/JUC-ThreadPoolExecutor",title:"ThreadPoolExecutor",description:"\u7ebf\u7a0b\u6c60\u7684\u76ee\u7684\u5728\u4e8e\u590d\u7528\u7ebf\u7a0b\uff0c\u907f\u514d\u9891\u7e41\u521b\u5efa\u548c\u9500\u6bc1\u7ebf\u7a0b\u5e26\u6765\u7684\u5f00\u9500\uff0c\u5e76\u63a7\u5236\u5e76\u53d1\u91cf\uff0c\u9650\u5236\u540c\u65f6\u6267\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\uff0c\u9632\u6b62\u7cfb\u7edf\u8d44\u6e90\u88ab\u8fc7\u5ea6\u5360\u7528\u3002",source:"@site/docs/JavaDocs/JUC/JUC-ThreadPoolExecutor.mdx",sourceDirName:"JavaDocs/JUC",slug:"/JavaDocs/JUC/JUC-ThreadPoolExecutor",permalink:"/analysis-project/docs/JavaDocs/JUC/JUC-ThreadPoolExecutor",draft:!1,unlisted:!1,editUrl:"https://github.com/Swagger-Ranger/analysis-project/docs/JavaDocs/JUC/JUC-ThreadPoolExecutor.mdx",tags:[],version:"current",sidebarPosition:6,frontMatter:{title:"ThreadPoolExecutor",sidebar_position:6,toc_min_heading_level:2,toc_max_heading_level:5},sidebar:"jdkSidebar",previous:{title:"\u5e76\u53d1\u5bb9\u5668",permalink:"/analysis-project/docs/JavaDocs/JUC/JUC-\u5e76\u53d1\u5bb9\u5668"},next:{title:"ForkJoinPool",permalink:"/analysis-project/docs/JavaDocs/JUC/JUC-ForkJoinPool"}},d={},s=[{value:"\u7ebf\u7a0b\u6c60\u7684\u7ed3\u6784",id:"\u7ebf\u7a0b\u6c60\u7684\u7ed3\u6784",level:3},{value:"\u6838\u5fc3\u6784\u9020\u53c2\u6570",id:"\u6838\u5fc3\u6784\u9020\u53c2\u6570",level:4},{value:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784",id:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784",level:4},{value:"\u5185\u90e8\u72b6\u6001\u53d8\u91cf",id:"\u5185\u90e8\u72b6\u6001\u53d8\u91cf",level:4},{value:"\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c",id:"\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c",level:3},{value:"\u4efb\u52a1\u63d0\u4ea4",id:"\u4efb\u52a1\u63d0\u4ea4",level:4},{value:"\u4efb\u52a1\u6267\u884c",id:"\u4efb\u52a1\u6267\u884c",level:4},{value:"\u4efb\u52a1\u5b8c\u6210\u5904\u7406WorkerExit",id:"\u4efb\u52a1\u5b8c\u6210\u5904\u7406workerexit",level:4},{value:"\u7ebf\u7a0b\u6c60\u5173\u95ed\u9000\u51fa",id:"\u7ebf\u7a0b\u6c60\u5173\u95ed\u9000\u51fa",level:4},{value:"ScheduledThreadPoolExecutor",id:"scheduledthreadpoolexecutor",level:3},{value:"\u5185\u90e8\u5b9e\u73b0",id:"\u5185\u90e8\u5b9e\u73b0",level:4}];function a(e){const n={blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\u7684\u76ee\u7684\u5728\u4e8e\u590d\u7528\u7ebf\u7a0b\uff0c\u907f\u514d\u9891\u7e41\u521b\u5efa\u548c\u9500\u6bc1\u7ebf\u7a0b\u5e26\u6765\u7684\u5f00\u9500\uff0c\u5e76\u63a7\u5236\u5e76\u53d1\u91cf\uff0c\u9650\u5236\u540c\u65f6\u6267\u884c\u7684\u7ebf\u7a0b\u6570\u91cf\uff0c\u9632\u6b62\u7cfb\u7edf\u8d44\u6e90\u88ab\u8fc7\u5ea6\u5360\u7528\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a\u5728jdk21\u6b63\u5f0f\u53d1\u5e03\u7684\u865a\u62df\u7ebf\u7a0b\u4ee5\u53ca\u540e\u7eed\u8ba1\u5212\u53d1\u5e03\u7684\u7ed3\u6784\u5316\u5e76\u53d1\u4e2d\uff0c\u865a\u62df\u7ebf\u7a0b\u662f\u4e0d\u9700\u8981\u4f7f\u7528\u7ebf\u7a0b\u6c60\u7684\uff0c\u56e0\u4e3a\u53ef\u4ee5\u5927\u91cf\u800c\u4e14\u4f4e\u6210\u672c\u7684\u521b\u5efa\u865a\u62df\u7ebf\u7a0b\u3002\u8fd9\u76f4\u63a5\u548c\u7ebf\u7a0b\u6c60\u7684\u8bbe\u8ba1\u76ee\u7684\u5c31\u4e0d\u662f\u4e00\u56de\u4e8b\uff0c\u56e0\u4e3a\u4e24\u8005\u7684\u7ebf\u7a0b\u6a21\u578b\u4e0d\u4e00\u6837\u3002"})}),"\n",(0,t.jsx)(n.p,{children:"\u5177\u4f53\u7684\u7528\u6cd5\u5c31\u4e0d\u8bf4\u4e86\uff0c\u76f4\u63a5\u770b\u6570\u636e\u7ed3\u6784\u548c\u5b9e\u73b0\u6e90\u7801\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u7ebf\u7a0b\u6c60\u7684\u7ed3\u6784",children:"\u7ebf\u7a0b\u6c60\u7684\u7ed3\u6784"}),"\n",(0,t.jsx)(n.h4,{id:"\u6838\u5fc3\u6784\u9020\u53c2\u6570",children:"\u6838\u5fc3\u6784\u9020\u53c2\u6570"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"corePoolSize"}),"\uff1a\u5728\u7ebf\u7a0b\u6c60\u4e2d\u59cb\u7ec8\u7ef4\u62a4\u7684\u7ebf\u7a0b\u4e2a\u6570\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"maxPoolSize"}),"\uff1a\u5728",(0,t.jsx)(n.code,{children:"corePooSize"}),"\u5df2\u6ee1\u3001\u961f\u5217\u4e5f\u6ee1\u7684\u60c5\u51b5\u4e0b\uff0c\u6269\u5145\u7ebf\u7a0b\u81f3\u6b64\u503c\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"keepAliveTime/TimeUnit"}),"\uff1a",(0,t.jsx)(n.code,{children:"maxPoolSize"})," \u4e2d\u7684\u7a7a\u95f2\u7ebf\u7a0b\uff0c\u9500\u6bc1\u6240\u9700\u8981\u7684\u65f6\u95f4\uff0c\u603b\u7ebf\u7a0b\u6570\u6536\u7f29\u56de",(0,t.jsx)(n.code,{children:"corePoolSize"}),"\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"blockingQueue"}),"\uff1a\u7ebf\u7a0b\u6c60\u6240\u7528\u7684\u961f\u5217\u7c7b\u578b\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"threadFactory"}),"\uff1a\u7ebf\u7a0b\u521b\u5efa\u5de5\u5382\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\uff0c\u4e5f\u6709\u4e00\u4e2a\u9ed8 \u8ba4\u7684\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"RejectedExecutionHandler"}),"\uff1a",(0,t.jsx)(n.code,{children:"corePoolSize"}),"\u5df2\u6ee1\uff0c\u961f\u5217\u5df2\u6ee1\uff0cmaxPoolSize\u5df2\u6ee1\uff0c\u6700\u540e\u7684\u62d2\u7edd\u7b56\u7565\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd96\u4e2a\u914d\u7f6e\u53c2\u6570\u6d89\u53ca\u5411\u7ebf\u7a0b\u6c60\u4e2d\u63d0\u4ea4\u4efb\u52a1\u7684\u65f6\u5019\uff0c\u7ebf\u7a0b\u6c60\u4f1a\u8fd9\u4e48\u8fd0\u884c\uff0c\u6709\u5982\u4e0b\u7684\u5904\u7406\u6d41\u7a0b:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"step1:\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6570\u662f\u5426\u5927\u4e8e\u6216\u7b49\u4e8ecorePoolSize\u3002\u5982\u679c\u5c0f\u4e8e\uff0c\u5219\u65b0\u5efa\u7ebf\u7a0b\u6267\u884c\uff0c\u5982\u679c\u5927\u4e8e\uff0c\u5219\u8fdb\u5165step2\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"step2:\u5224\u65ad\u961f\u5217\u662f\u5426\u5df2\u6ee1\uff1a\u5982\u672a\u6ee1\uff0c\u5219\u653e\u5165\uff0c\u5982\u5df2\u6ee1\uff0c\u5219\u8fdb\u5165st ep3\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"step3:\u5224\u65ad\u5f53\u524d\u7ebf\u7a0b\u6570\u662f\u5426\u5927\u4e8e\u6216\u7b49\u4e8emaxPoolSize\u3002\u5982\u679c\u5c0f\u4e8e\uff0c\u5219\u65b0\u5efa\u7ebf\u7a0b\u6267\u884c\uff0c\u5982\u679c\u5927\u4e8e\uff0c\u5219\u8fdb\u5165step4\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"step4:\u6839\u636e\u62d2\u7edd\u7b56\u7565\uff0c\u62d2\u7edd\u4efb\u52a1\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"\u5373\uff1a\u9996\u5148\u5224\u65adcorePoolSize\uff0c\u5176\u6b21\u5224\u65adblockingQueue\u662f\u5426\u5df2\u6ee1\uff0c\u63a5\u7740\u5224\u65admaxPoolSize\uff0c\u6700\u540e\u4f7f\u7528\u62d2\u7edd\u7b56\u7565\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u5982\u679c\u961f\u5217\u662f\u65e0\u754c\u7684\uff0c\u5c06\u6c38\u8fdc\u6ca1\u6709\u673a\u4f1a\u8d70\u5230step 3\uff0c\u4e5f\u5373maxPoolSize\u6ca1\u6709\u4f7f\u7528\uff0c\u4e5f\u4e00\u5b9a\u4e0d\u4f1a\u8d70\u5230step 4\u3002\u8fd9\u4e5f\u5c31\u662f\u5f00\u53d1\u89c4\u8303\u4e2d\u4e3a\u4ec0\u4e48\u8981\u8981\u6c42\u624b\u52a8\u521b\u5efa\u7ebf\u7a0b\u6c60\uff0c\u800c\u4e0d\u662f\u4f7f\u7528",(0,t.jsx)(n.code,{children:"Exectors"}),"\u521b\u5efa\uff0c\u907f\u514d\u65e0\u9650\u521b\u5efa\u7ebf\u7a0b\u800c",(0,t.jsx)(n.code,{children:"OOM"}),"\uff08\u56e0\u4e3a\u5e73\u53f0\u7ebf\u7a0b\u6bcf\u4e2a\u7ebf\u7a0b\u521b\u5efa\u65f6\u90fd\u81f3\u5c11\u4f1a\u5206\u914d1M\u7684\u5185\u5b58\uff0c\u4e3b\u8981\u7528\u4e8e\u7ebf\u7a0b\u7684\u6808\uff08stack\uff09/\u5373\u7ebf\u7a0b\u72ec\u6709\u7684\u865a\u62df\u673a\u6808\uff0c\u4ee5\u7528\u4e8e\u7ebf\u7a0b\u7ba1\u7406\u3001\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf\u5b58\u50a8\u7b49\uff09\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784",children:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784"}),"\n",(0,t.jsx)(n.p,{children:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784\uff0c\u6211\u76f4\u63a5\u8d34\u51fa\u4ee3\u7801\uff0c\u6839\u636e\u4ee3\u7801\u6765\u89e3\u91ca\uff0c\u4e0d\u7136\u5f88\u591a\u7ec6\u8282\u8bb2\u4e0d\u6e05\u695a\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"    // \u4efb\u52a1\u7684\u963b\u585e\u961f\u5217\n    private final BlockingQueue<Runnable> workQueue;\n\n\t\t// \u7ebf\u7a0b\u6c60\u5185\u90e8\u53d8\u91cf\u4e92\u65a5\u8bbf\u95ee\u7684\u63a7\u5236\n    private final ReentrantLock mainLock = new ReentrantLock();\n\n    // \u7ebf\u7a0b\u96c6\u5408\n    private final HashSet<Worker> workers = new HashSet<>();\n\n    // \u6267\u884c\u5668 Worker\uff0c\u4e5f\u662f\u4f7f\u7528\u7684aqs\uff0cworker\u76f4\u63a5\u7ee7\u627faqs\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u4f7f\u7528\u5176\u72ec\u5360\u9501\u7684\u529f\u80fd\u5e76\u7ba1\u7406\u5176\u7ebf\u7a0b\u72b6\u6001\uff0c\u800c\u4e0d\u7528\u518d\u53bb\u4e3a\u4e86Worker\u624b\u52a8\u5b9e\u73b0\u4e00\u5957\u8c03\u7528LockSupport.park/unpark\u7684\u9488\u5bf9\u7279\u5b9a\u7ebf\u7a0b\u7684\u963b\u585e/\u5524\u9192\u548c\u534f\u8c03\u72b6\u6001\u7684\u65b9\u6cd5\u3002\u4e0b\u9762\u5c31\u662fWorker\u7684\u6e90\u7801\n    private final class Worker\n        extends AbstractQueuedSynchronizer\n        // \u6ce8\u610fWorker\u4e5f\u5b9e\u73b0\u4e86Runnable\uff0c\u4e5f\u5c31\u662f\u63d0\u4ea4\u7684\u4efb\u52a1\u90fd\u88ab\u5c01\u88c5\u6210\u4e86 Worker\n        implements Runnable\n    {\n        private static final long serialVersionUID = 6138294804551838833L;\n\n        final Thread thread;\n\n        // \u4efb\u52a1\u90fd\u662f\u5c01\u88c5\u5728 firstTask\u4e2d\u7684\uff0c\u800c\u4e14\u672c\u8eab\u6ca1\u6709\u7ef4\u6301\u4efb\u52a1\u961f\u5217\uff0c\u53ea\u6709\u4e00\u4e2a\u4efb\u52a1\uff0c\u5982\u679cfirstTask\u4e0d\u4e3a null\uff0c\u90a3\u4e48 Worker \u7ebf\u7a0b\u542f\u52a8\u540e\u4f1a\u7acb\u5373\u6267\u884c\u8fd9\u4e2a\u4efb\u52a1\u3002\n        Runnable firstTask;\n\n        volatile long completedTasks;\n\n        Worker(Runnable firstTask) {\n            // \u76f4\u63a5\u7528AQS\u63d0\u4f9b\u7684state\u53d8\u91cf\u6765\u8868\u793aWorker\u7684\u4e0d\u540c\u72b6\u6001\uff1a\u6bd4\u5982\u662f\u5426\u6b63\u5728\u6267\u884c\u4efb\u52a1\u3001\u662f\u5426\u7a7a\u95f2\u7b49\u3002\u901a\u8fc7\u8fd9\u4e9b\u72b6\u6001\u7ebf\u7a0b\u6c60\u53ef\u4ee5\u66f4\u597d\u5730\u63a7\u5236\u7ebf\u7a0b\u7684\u751f\u547d\u5468\u671f\u3002\n            setState(-1); // inhibit interrupts until runWorker\n            this.firstTask = firstTask;\n            this.thread = getThreadFactory().newThread(this);\n        }\n\n        /** Delegates main run loop to outer runWorker. */\n        public void run() {\n            runWorker(this);\n        }\n\n        protected boolean isHeldExclusively() {\n            return getState() != 0;\n        }\n\n        // tryAcquire\u548ctryRelease\u5c31\u662faqs\u63d0\u4f9b\u7684\u6a21\u7248\u65b9\u6cd5\uff0c\u6b64\u5904\u5c31\u662f\u76f4\u63a5\u8bbe\u7f6e\u72ec\u5360\u9501\n        protected boolean tryAcquire(int unused) {\n            if (compareAndSetState(0, 1)) {\n                setExclusiveOwnerThread(Thread.currentThread());\n                return true;\n            }\n            return false;\n        }\n\n        protected boolean tryRelease(int unused) {\n            setExclusiveOwnerThread(null);\n            setState(0);\n            return true;\n        }\n\n        // lock/tryLock\u7684\u8fd9\u51e0\u4e2a\u65b9\u6cd5\u5c31\u662f\u5bf9\u5916\u66b4\u9732\u7684\u65b9\u6cd5\n        public void lock()        { acquire(1); }\n        public boolean tryLock()  { return tryAcquire(1); }\n        public void unlock()      { release(1); }\n        public boolean isLocked() { return isHeldExclusively(); }\n\n        void interruptIfStarted() {\n            Thread t;\n            if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n                try {\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                }\n            }\n        }\n    }\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u5185\u90e8\u72b6\u6001\u53d8\u91cf",children:"\u5185\u90e8\u72b6\u6001\u53d8\u91cf"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"    // \u521d\u59cb\u7ebf\u7a0b\u6570\u4e3a0\n    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\n    // ctl\u53d8\u91cf\u88ab\u62c6\u6210\u4e24\u534a\uff0c\u6700\u9ad8\u76843\u4f4d\u7528\u6765\u8868 \u793a\u7ebf\u7a0b\u6c60\u7684\u72b6\u6001\uff0c\u4f4e\u768429\u4f4d\u8868\u793a\u7ebf\u7a0b\u7684\u4e2a\u6570\n    private static final int COUNT_BITS = Integer.SIZE - 3;// Integer.SIZE=32\n    private static final int COUNT_MASK = (1 << COUNT_BITS) - 1;\n\n    // runState is stored in the high-order bits\uff0c\u7ebf\u7a0b\u5b58\u50a8\u5b58\u50a8\u5728\u9ad8\u4f4d\uff0c5\u4e2a\u5c31\u81f3\u5c11\u9700\u89813\u4e2a\u4e8c\u8fdb\u5236\u4f4d\n    // \u7ebf\u7a0b\u6c60\u7684\u72b6\u6001\u6709\u4e94\u79cd\uff0c\u5206\u522b\u662fRUNNING\u3001SHUTDOWN\u3001STOP\u3001TIDYING\u548cTERMINATED\u3002\n    private static final int RUNNING    = -1 << COUNT_BITS;//\u9ad83\u4f4d\u624d\u662f\u72b6\u6001\u4f4d\uff0c\u6240\u4ee5\u8981\u4f4d\u79fb29\n    private static final int SHUTDOWN   =  0 << COUNT_BITS;\n    private static final int STOP       =  1 << COUNT_BITS;\n    private static final int TIDYING    =  2 << COUNT_BITS;\n    private static final int TERMINATED =  3 << COUNT_BITS;\n\n    //\u53ef\u4ee5\u770b\u5230\u4e0a\u9762 ctl\u53d8\u91cf\u5c31\u662f\u901a\u8fc7\u4e0b\u9762\u7684\u51fd\u6570\u76f4\u63a5\u5408\u5e76\u4e24\u4e2a\u53d8\u91cf\uff0c\u76f4\u63a5\u4f4d\u8fd0\u7b97\u7ed3\u5408\u8fd0\u884c\u72b6\u6001\u548c\u7ebf\u7a0b\u6570\u91cf\n    // rs|wc:\u5c31\u662f\u5c06\u4e24\u8005\u5408\u5e76\u6210\u4e86\u4e00\u4e2a\u5355\u4e00\u7684int\u503c;rs\u5c31\u662f\u6307\u4ee3\u9ad83\u4f4d\u7684\u8fd0\u884c\u72b6\u6001\uff0cwc\u5c31\u662f\u4f4e29\u4f4d\u7684\u7ebf\u7a0b\u6570\u91cf\n    private static int ctlOf(int rs, int wc) { return rs | wc; }\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\u72b6\u6001\u7684\u8f6c\u6362\uff0c\u5982\u4e0b\u56fe\uff1a"}),"\n",(0,t.jsx)("div",{style:{textAlign:"center",width:"100%"},children:(0,t.jsx)("img",{src:"/analysis-project/img/juc/juc-21.png",alt:"image",style:{maxWidth:"68%",height:"auto",display:"block",margin:"0 auto"}})}),"\n",(0,t.jsx)(n.p,{children:"\u72b6\u6001\u8fc1\u79fb\u53ea\u4f1a\u4ece\u5c0f\u5230\u5927\u8fc1\u79fb\uff0c-1--\x3e 0 --\x3e 1 --\x3e 2 --\x3e 3\uff0c\u4e0d\u4f1a\u9006\u5411\u8fc1\u79fb\u3002\u4f8b\u5982\uff1a\u5f53\u7ebf\u7a0b\u6c60\u7684\u72b6\u6001\u5728TIDYING=2\u65f6\uff0c\u63a5\u4e0b\u6765\u53ea\u53ef\u80fd\u8fc1\u79fb\u5230TERMINATED =3\uff0c\u4e0d\u53ef\u80fd\u8fc1\u79fb\u56deSTOP=1\u6216\u8005\u5176\u4ed6\u72b6\u6001\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c",children:"\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c"}),"\n",(0,t.jsx)(n.p,{children:"\u7ebf\u7a0b\u6c60\u7684\u8fd0\u884c\u6211\u6ca1\u6709\u5199\u4e00\u4e2a\u6c47\u603b\uff0c\u56e0\u4e3a\u7ec6\u8282\u633a\u591a\u7684\uff0c\u6309\u7167\u4e0b\u9762\u7684\u987a\u5e8f\uff0c\u6bcf\u4e2a\u6267\u884c\u903b\u8f91\u90fd\u6ce8\u91ca\u5728\u4ee3\u7801\u4e2d\uff0c\u4e0b\u9762\u7684\u987a\u5e8f\u5c31\u662f\u7ebf\u7a0b\u6c60\u7684\u5b9e\u9645\u6267\u884c\u987a\u5e8f\uff1a\u4efb\u52a1\u63d0\u4ea4 --\x3e \u4efb\u52a1\u6267\u884c --\x3e \u4efb\u52a1\u5b8c\u6210\u5904\u7406 --\x3e \u7ebf\u7a0b\u6c60\u5173\u95ed\u9000\u51fa\u3002"}),"\n",(0,t.jsx)(n.h4,{id:"\u4efb\u52a1\u63d0\u4ea4",children:"\u4efb\u52a1\u63d0\u4ea4"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"}),"\u4efb\u52a1\u7684\u63d0\u4ea4\u90fd\u662f\u901a\u8fc7",(0,t.jsx)(n.code,{children:"execute"}),"\u65b9\u6cd5\uff0c\u6e90\u7801\u91cc\u8bf4\u5f97\u5f88\u6e05\u695a\uff0c\u76f4\u63a5\u770b\u6e90\u7801\uff0c\u7ec6\u8282\u6211\u90fd\u52a0\u4e86\u6ce8\u91ca\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public void execute(Runnable command) {\n        if (command == null)\n            throw new NullPointerException();\n        /*\n         * Proceed in 3 steps:\n         *\n         * 1. If fewer than corePoolSize threads are running, try to\n         * ...\n         */\n        int c = ctl.get();\n        // \u5982\u679c\u5f53\u524d\u7684\u7ebf\u7a0b\u6570\u5c0f\u4e8e corePoo1Size\uff0c\u5219\u5f00\u65b0\u7ebf\u7a0b\n        if (workerCountOf(c) < corePoolSize) {\n            if (addWorker(command, true))\n                return;\n            c = ctl.get();\n        }\n        // //\u5982\u679c\u5f53\u524d\u7684\u7ebf\u7a0b\u6570\u5927\u4e8e\u6216\u7b49\u4e8e corePoresize\uff0c\u5219\u8c03\u7528 workQueue.offer \u653e\u5165\u961f\u5217\n        if (isRunning(c) && workQueue.offer(command)) {\n            int recheck = ctl.get();\n            if (! isRunning(recheck) && remove(command))\n                reject(command);\n            else if (workerCountOf(recheck) == 0)\n                // \u8fd9\u91cc\u5982\u679c\u5de5\u4f5c\u7ebf\u7a0b\u6570\u91cf\u4e3a0\u4e86\u5c31\u52a0\u5165\u4e00\u4e2aworker\n                addWorker(null, false);\n        }\n        // \u653e\u5165\u961f\u5217\u5931\u8d25\uff0c\u5219\u5f00\u65b0\u7ebf\u7a0b\n        else if (!addWorker(command, false))\n            // \u7ebf\u7a0b\u6570\u5927\u4e8emaxPoo1Size\uff0c\u8c03\u7528\u62d2\u7edd\u7b56\u7565\n            reject(command);\n    }\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e",(0,t.jsx)(n.code,{children:"addWorker"}),"\u65b9\u6cd5\u662f\u63d0\u4ea4\u4efb\u52a1\u7684\u6838\u5fc3"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"    // \u65b0\u5f00\u4e00\u4e2a\u7ebf\u7a0b\u3002core:true\uff0c\u5219corePoo1Size \u4f5c\u4e3a\u4e0a\u754c\uff1bfalse\uff0c\u5219 maxPoolSize \u4f5c\u4e0a\u754c\n    private boolean addWorker(Runnable firstTask, boolean core) {\n        retry:\n        for (int c = ctl.get();;) {\n            // Check if queue empty only if necessary.\n            if (runStateAtLeast(c, SHUTDOWN)\n                // \u8fd9\u91cc\u5982\u679c\u72b6\u6001\u662fSHUTDOWN\u65f6\uff0c\u4ecd\u7136\u8981\u5c06\u5df2\u6709\u7684\u4efb\u52a1\u6267\u884c\u5b8c\uff0c\u6240\u4ee5\u8fd8\u8981\u5224\u65adfirstTask\u548c\u961f\u5217\u662f\u5426\u4e3a\u7a7a\n                && (runStateAtLeast(c, STOP)\n                    || firstTask != null\n                    || workQueue.isEmpty()))\n                return false;\n\n            for (;;) {\n                if (workerCountOf(c)\n                    >= ((core ? corePoolSize : maximumPoolSize) & COUNT_MASK))\n                    return false;\n                // \u8fd9\u91cc\u5148\u4fee\u6539\u7ebf\u7a0b\u6c60\u7684ctl\uff0c\u5c06\u5176+1\uff1b\u4f46\u4e0d\u4f1a\u6539\u53d8\u6b64\u5904\u7684\u5c40\u90e8\u53d8\u91cfc\uff0cc\u4ecd\u7136\u4e0d\u53d8\uff0c\u518d\u6b21\u91cd\u65b0\u8fdb\u5165retry\u5faa\u73af\n                if (compareAndIncrementWorkerCount(c))\n                    break retry;\n                // \u8fd9\u91cc\u4e0a\u4e00\u6b65compareAndIncrementWorkerCount\u5931\u8d25\u5c31\u4f1a\u6267\u884c\uff0c\u6240\u6709\u8981\u518d\u6b21\u5224\u65ad\n                c = ctl.get();  // Re-read ctl\n                if (runStateAtLeast(c, SHUTDOWN))\n                    continue retry;\n                // else CAS failed due to workerCount change; retry inner loop\n            }\n        }\n\n        boolean workerStarted = false;\n        boolean workerAdded = false;\n        Worker w = null;\n        try {\n            w = new Worker(firstTask);\n            final Thread t = w.thread;\n            // t != null\u5224\u65ad\uff0cnew Worker\u4e2d\u8c03\u7528\u7ebf\u7a0b\u5de5\u7a0b\u521b\u5efa\u7ebf\u7a0b\uff0c\u8fd9\u91cc\u9632\u5fa1\u7f16\u7a0b\uff0c\u5982\u679c\u7528\u6237\u4f20\u5165\u7684\u7ebf\u7a0b\u5de5\u7a0b\u6709\u5f02\u5e38\u65e0\u6cd5\u521b\u5efa\u7ebf\u7a0b\uff0c\u5219\u76f4\u63a5\u8fdb\u5165\u540e\u9762\u521b\u5efa\u5931\u8d25addWorkerFailed\u7684\u903b\u8f91\n            if (t != null) {\n                final ReentrantLock mainLock = this.mainLock;\n                mainLock.lock();\n                try {\n                    // Recheck while holding lock.\n                    // Back out on ThreadFactory failure or if\n                    // shut down before lock acquired.\n                    int c = ctl.get();\n\n                    if (isRunning(c) ||\n                        (runStateLessThan(c, STOP) && firstTask == null)) {\n                        if (t.getState() != Thread.State.NEW)\n                            throw new IllegalThreadStateException();\n                        // \u5c06new\u7684\u7ebf\u7a0b(w = new Worker(firstTask))\u52a0\u5165\u7ebf\u7a0b\u96c6\u5408\n                        workers.add(w);\n                        workerAdded = true;\n                        int s = workers.size();\n                        if (s > largestPoolSize)\n                            largestPoolSize = s;\n                    }\n                } finally {\n                    mainLock.unlock();\n                }\n                if (workerAdded) {\n                    // \u542f\u52a8\u7ebf\u7a0b\uff0c\u6211\u7684\u662fjdk21\uff0c\u6240\u4ee5\u4f7f\u7528\u7684jvm\u5185\u90e8\u7684SharedThreadContainer\u6765\u542f\u52a8\u7ebf\u7a0b\n                    // \u5e76\u4e14\u56e0\u4e3aWorker\u7ee7\u627f\u4e86Runnable\uff0c\u6240\u4ee5\u4efb\u52a1\u88ab\u5c01\u88c5\u5230\u4e86Worker\u91cc\uff0c\u7136\u540e\u6b64\u7ebf\u7a0bstart\u542f\u52a8\u5c31\u662f\u6267\u884c\u5c01\u88c5\u4e86Runble\u7684Worker\u7684run\u65b9\u6cd5\n                    container.start(t);\n                    workerStarted = true;\n                }\n            }\n        } finally {\n            if (! workerStarted)\n                addWorkerFailed(w);\n        }\n        return workerStarted;\n    }\n\n      //\u8981\u6267\u884c\u7684\u4efb\u52a1\u90fd\u88ab\u5c01\u88c5\u5728\u4e86Worker\u4e2d\uff0c\u6240\u4ee5getThreadFactory().newThread(this);\u8fd9\u91cc\u7684this\u5c31\u662f\u5c01\u88c5\u4e86\u7684Runnable\u4efb\u52a1\n      Worker(Runnable firstTask) {\n            setState(-1); // inhibit interrupts until runWorker\n            this.firstTask = firstTask;\n            this.thread = getThreadFactory().newThread(this);\n        }\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u4efb\u52a1\u6267\u884c",children:"\u4efb\u52a1\u6267\u884c"}),"\n",(0,t.jsxs)(n.p,{children:["\u4efb\u52a1\u6267\u884c\u90fd\u5728Worker\u4e2d\uff0c\u5c01\u88c5\u7684Worker\u7684run()\u65b9\u6cd5\u76f4\u63a5\u8c03\u7528\u7684",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor#runWorker"}),"\u65b9\u6cd5\uff0c\u5982\u4e0b\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"//\nfinal void runWorker(Worker w) {\n        // \u8fd9\u91cc\u7684wt\u548cw\u5176\u5b9e\u90fd\u662f\u4e00\u4e2a\u7ebf\u7a0b\u7684\uff0cwt\u7ebf\u7a0b\u5c31\u662f\u4eceworker\u521b\u5efa\u7684\u7ebf\u7a0b\u542f\u52a8\u7684\uff0c\u53ea\u662f\u8fd9\u91cc\u662f\u4e24\u4e2a\u4e0d\u540c\u7684\u89c6\u89d2\uff1awt\u8868\u793aworker thread\u6267\u884c\u7684\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u800cw\u5c31\u662f\u6307\u5c01\u88c5\u7684worker\u5bf9\u8c61\n        Thread wt = Thread.currentThread();\n        Runnable task = w.firstTask;\n        w.firstTask = null;\n        w.unlock(); // allow interrupts\n        boolean completedAbruptly = true;\n        try {\n            // \u4e0d\u65ad\u7684\u53d6\u4efb\u52a1\uff0c\u8fd9\u4e2awhile\u5c31\u662f\u7ebf\u7a0b\u6c60\u4e2d\u53ea\u8981\u8fd8\u6709\u4efb\u52a1\u7ebf\u7a0b\u5c31\u4e0d\u4f1a\u9000\u51fa\uff0cgetTask\u5c31\u662f\u5728\u4efb\u52a1\u961f\u5217\u4e2dworkQueue.take()\u53d6\u7684\u4efb\u52a1\n            while (task != null || (task = getTask()) != null) {\n                w.lock();\n                // If pool is stopping, ensure thread is interrupted;\n                // if not, ensure thread is not interrupted.  This\n                // requires a recheck in second case to deal with\n                // shutdownNow race while clearing interrupt\n                if ((runStateAtLeast(ctl.get(), STOP) ||\n                     (Thread.interrupted() &&\n                      runStateAtLeast(ctl.get(), STOP))) &&\n                    !wt.isInterrupted())\n                    // \u8fd9\u91cc\u5c31\u662f\u5728\u5224\u65ad\u5982\u679cSTOP\u4e86\uff0cwt\u8fd9\u4e2aworker\u7684\u6267\u884c\u7ebf\u7a0b\u5c31\u8981\u81ea\u5df1\u6253\u65ad\u81ea\u5df1\n                    wt.interrupt();\n                try {\n                    // \u6a21\u7248\u65b9\u6cd5\uff0c\u63d0\u4f9b\u7ed9\u5b50\u7c7b\u81ea\u5b9a\u4e49\u5b9e\u73b0\u7684\uff0c\u5728ThreadPoolExecutor\u662f\u7a7a\u65b9\u6cd5\n                    beforeExecute(wt, task);\n                    try {\n                        // \u4efb\u52a1\u6267\u884c\n                        task.run();\n                        // \u6a21\u7248\u65b9\u6cd5\uff0c\u63d0\u4f9b\u7ed9\u5b50\u7c7b\u81ea\u5b9a\u4e49\u5b9e\u73b0\u7684\uff0c\u5728ThreadPoolExecutor\u662f\u7a7a\u65b9\u6cd5\n                        afterExecute(task, null);\n                    } catch (Throwable ex) {\n                       // \u6a21\u7248\u65b9\u6cd5\uff0c\u63d0\u4f9b\u7ed9\u5b50\u7c7b\u81ea\u5b9a\u4e49\u5b9e\u73b0\u7684\uff0c\u5728ThreadPoolExecutor\u662f\u7a7a\u65b9\u6cd5\n                        afterExecute(task, ex);\n                        throw ex;\n                    }\n                } finally {\n                    task = null;\n                    w.completedTasks++;\n                    w.unlock();\n                }\n            }\n            // \u8fd9\u91cc\u5982\u679c\u4e0a\u9762\u7684try finally\u6709\u5f02\u5e38\u6216\u8005\u4e2d\u65ad\uff0c\u6ca1\u6709\u6267\u884c\u5b8c\uff0c\u5219\u8fd9\u884c\u4e0d\u4f1a\u88ab\u6267\u884c\uff0c\u800c\u662f\u76f4\u63a5\u8fdb\u5165\u4e0b\u4e00\u4e2afinally\u4e2d\uff0c\u5bfc\u81f4completedAbruptly\u6ca1\u6709\u88ab\u4fee\u6539\u8fd8\u662f\u4e3atrue\n            completedAbruptly = false;\n        } finally {\n            processWorkerExit(w, completedAbruptly);\n        }\n    }\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u83b7\u53d6\u4efb\u52a1\u65b9\u6cd5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5f88\u5173\u952e\uff0c\u56e0\u4e3a\u5f53\u7ebf\u7a0b\u7a7a\u95f2\u65f6\u5c31\u4f1a\u963b\u585e\u5728getTask\u4e2d"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"private Runnable getTask() {\n        boolean timedOut = false; // Did the last poll() time out?\n        for (;;) {\n            int c = ctl.get();\n\n            // Check if queue empty only if necessary.\n            if (runStateAtLeast(c, SHUTDOWN)\n                && (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {\n                decrementWorkerCount();\n                return null;\n            }\n\n            int wc = workerCountOf(c);\n\n            // Are workers subject to culling?\n            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n            if ((wc > maximumPoolSize || (timed && timedOut))\n                && (wc > 1 || workQueue.isEmpty())) {\n                if (compareAndDecrementWorkerCount(c))\n                    return null;\n                continue;\n            }\n\n            try {\n                Runnable r = timed ?\n                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n                    // BlockingQueue\u662f\u4e00\u4e2a\u963b\u585e\u961f\u5217\uff0cworkQueue.take();\u5f53\u961f\u5217\u4e3a\u7a7a\u65f6\u7ebf\u7a0b\u4f1a\u963b\u585e\uff0c\u6b64\u5904\u8fd8\u662f\u4e00\u76f4\u963b\u585e\u7684\uff0ctake\u662f\u4f1a\u629b\u51faInterruptedException\u7684\n                    workQueue.take();\n                if (r != null)\n                    return r;\n                timedOut = true;\n            } catch (InterruptedException retry) {\n                timedOut = false;\n            }\n        }\n    }\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u4efb\u52a1\u5b8c\u6210\u5904\u7406workerexit",children:"\u4efb\u52a1\u5b8c\u6210\u5904\u7406WorkerExit"}),"\n",(0,t.jsx)(n.p,{children:"\u4efb\u52a1\u6267\u884c\u5b8c\u540e\u7684\u903b\u8f91\u5904\u7406\uff0c\u8fd9\u91cc\u8981\u5904\u7406\u7ebf\u7a0b\u6c60\u4e2d\u7ebf\u7a0b\u6570\u91cf\u7684\u7ef4\u62a4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"private void processWorkerExit(Worker w, boolean completedAbruptly) {\n        // \u5982\u679ccompletedAbruptly=true\u5c31\u662f\u5f02\u5e38\u9000\u51fa\uff0c\u9700\u8981\u526a\u6389\u7ebf\u7a0b\u6570\u91cf ctl.addAndGet(-1);\n        if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted\n            decrementWorkerCount();\n\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            completedTaskCount += w.completedTasks;\n            // \u6267\u884c\u5b8c\uff0c\u5c06worker\u79fb\u51faworkers\u7ebf\u7a0b\u96c6\u5408\uff0c\u8fd9\u91cc\u5148\u51cf\u6389\u7ebf\u7a0b\uff0c\u7136\u540e\u540e\u9762\u518d\u5224\u65ad\u662f\u5426\u9700\u8981\u628a\u7ebf\u7a0b\u52a0\u56de\u53bb\n            workers.remove(w);\n        } finally {\n            mainLock.unlock();\n        }\n\n        tryTerminate();\n\n        int c = ctl.get();\n        // \u7ebf\u7a0b\u6c60\u72b6\u6001\u5c0f\u4e8eSTOP\uff0cSHUTDOWN\u7684\u4e5f\u8981\u628a\u4efb\u52a1\u6267\u884c\u5b8c\n        if (runStateLessThan(c, STOP)) {\n            if (!completedAbruptly) {\n                // allowCoreThreadTimeOut\u662f\u8bbe\u7f6e\u7684\u6838\u5fc3\u7ebf\u7a0b\u662f\u5426\u9000\u51fa\u7684\u903b\u8f91\n                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;\n                if (min == 0 && ! workQueue.isEmpty())\n                    min = 1;\n                // workerCountOf(c) >= min\uff0c\u8fd9\u91cc\u6761\u4ef6\u4e0d\u6ee1\u8db3\uff0c\u5373\u4e0d\u7528\u5728\u65b0\u5efa\u7ebf\u7a0b\u6765\u7ef4\u6301\u7ebf\u7a0b\u6570\n                if (workerCountOf(c) >= min)\n                    return; // replacement not needed\n            }\n            // \u5982\u679c\u6ca1\u6709\u9000\u51faaddWorker(null, false)\u6765\u52a0\u4e00\u4e2a\u65b0\u7684\u5de5\u4f5c\u7ebf\u7a0b\u4ee5\u66ff\u4ee3\u5df2\u9000\u51fa\u7684\u7ebf\u7a0b\uff0c\u786e\u4fdd\u7ebf\u7a0b\u6c60\u4fdd\u6301\u8db3\u591f\u7684\u5de5\u4f5c\u7ebf\u7a0b\u3002addWorker(null, false) \u5c31\u662f\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u95f2\u7684\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u7136\u540e\u7ebf\u7a0b\u542f\u52a8\u6267\u884crun\u7136\u540e\u8c03\u7528runWorker\u65b9\u6cd5\u4ece\u4efb\u52a1\u961f\u5217\u4e2d\u83b7\u53d6\u4efb\u52a1\u6267\u884c\u3002\n            addWorker(null, false);\n        }\n    }\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u7ebf\u7a0b\u6c60\u5173\u95ed\u9000\u51fa",children:"\u7ebf\u7a0b\u6c60\u5173\u95ed\u9000\u51fa"}),"\n",(0,t.jsxs)(n.p,{children:["\u7ebf\u7a0b\u6c60\u6709\u4e24\u4e2a\u5173\u95ed\u51fd\u6570\uff0c",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u548c",(0,t.jsx)(n.code,{children:"shutdownNow()"}),"\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u4f1a\u8ba9\u7ebf\u7a0b\u6c60\u5207\u6362\u5230\u4e0d\u540c\u7684\u72b6\u6001\uff1a"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u63a5\u53d7\u65b0\u4efb\u52a1"}),"\uff1a",(0,t.jsx)(n.code,{children:"shutdown()"})," \u4e0d\u518d\u63a5\u53d7\u65b0\u4efb\u52a1\uff0c\u4f46\u4f1a\u7ee7\u7eed\u6267\u884c\u5df2\u63d0\u4ea4\u7684\u4efb\u52a1\u3002",(0,t.jsx)(n.code,{children:"shutdownNow()"})," \u4e0d\u518d\u63a5\u53d7\u65b0\u4efb\u52a1\uff0c\u5e76\u8bd5\u56fe\u53d6\u6d88\u6240\u6709\u7b49\u5f85\u548c\u6b63\u5728\u6267\u884c\u7684\u4efb\u52a1\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u7b49\u5f85\u961f\u5217\u5904\u7406"}),"\uff1a",(0,t.jsx)(n.code,{children:"shutdown()"})," \u4f1a\u6267\u884c\u7b49\u5f85\u961f\u5217\u4e2d\u7684\u6240\u6709\u4efb\u52a1\uff0c",(0,t.jsx)(n.code,{children:"shutdownNow()"})," \u5219\u4f1a\u8fd4\u56de\u7b49\u5f85\u961f\u5217\u4e2d\u6240\u6709\u672a\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5e76\u5c1d\u8bd5\u505c\u6b62\u6b63\u5728\u6267\u884c\u7684\u4efb\u52a1\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u4efb\u52a1\u7ec8\u6b62"}),"\uff1a",(0,t.jsx)(n.code,{children:"shutdown()"})," \u5141\u8bb8\u4efb\u52a1\u6709\u5e8f\u5b8c\u6210\uff0c\u800c ",(0,t.jsx)(n.code,{children:"shutdownNow()"})," \u8bd5\u56fe\u7acb\u5373\u7ec8\u6b62\u4efb\u52a1\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u5728\u4ee3\u7801\u5b9e\u73b0\u4e0a\uff0c\u4e24\u4e2a\u65b9\u6cd5\u5982\u4e0b\uff0c\u6240\u6709\u7684\u5dee\u5f02\u90fd\u5728\u4ee3\u7801\u6ce8\u91ca\u4e2d\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public void shutdown() {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            // \u5c06\u7ebf\u7a0b\u6c60\u72b6\u6001\u524d\u8fdb\u5230 SHUTDOWN\n            advanceRunState(SHUTDOWN);\n            // \u4e2d\u65ad\u7a7a\u95f2\u7684\u7ebf\u7a0b\n            interruptIdleWorkers();\n            onShutdown(); // hook for ScheduledThreadPoolExecutor\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n    }\n\npublic List<Runnable> shutdownNow() {\n        List<Runnable> tasks;\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            checkShutdownAccess();\n            // \u5c06\u7ebf\u7a0b\u6c60\u72b6\u6001\u524d\u8fdb\u5230 STOP\n            advanceRunState(STOP);\n            // \u4e2d\u65ad\u6240\u6709\u7684\u7ebf\u7a0b\n            interruptWorkers();\n            // \u6392\u7a7a\u4efb\u52a1\u961f\u5217 -- shutdown\u662f\u4e0d\u62cd\u5f00\u961f\u5217\u7684\n            tasks = drainQueue();\n        } finally {\n            mainLock.unlock();\n        }\n        tryTerminate();\n        // \u8fd4\u56de\u88ab\u6392\u7a7a\u7684\u4efb\u52a1\u96c6\u5408\n        return tasks;\n    }\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:" interruptIdleWorkers()"}),"\u65b9\u6cd5\u548c",(0,t.jsx)(n.code,{children:"interruptWorkers();"}),"\u65b9\u6cd5\u5dee\u5f02\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u8fd9\u91cconlyOne\u662f\u4e2d\u65ad\u4e00\u4e2a\u8fd8\u662f\u4e2d\u65ad\u6240\u6709\uff0c\n// onlyOne = true\uff0c\u8fd9\u79cd\u60c5\u51b5\u901a\u5e38\u7528\u4e8e\u5728\u67d0\u4e9b\u7279\u5b9a\u64cd\u4f5c\u4e2d\u5e0c\u671b\u4ec5\u5524\u9192\u4e00\u4e2a\u7ebf\u7a0b\u6765\u5904\u7406\u4e00\u4e9b\u7d27\u6025\u4efb\u52a1\u6216\u5f02\u5e38\u60c5\u51b5\n// onlyOne = false \u5f53\u5e0c\u671b\u7acb\u5373\u7ec8\u6b62\u7ebf\u7a0b\u6c60\u7684\u6240\u6709\u4efb\u52a1\u65f6\uff0c\u5c31\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u786e\u4fdd\u6240\u6709\u7a7a\u95f2\u7ebf\u7a0b\u90fd\u88ab\u4e2d\u65ad\u548c\u7ec8\u6b62\nprivate void interruptIdleWorkers(boolean onlyOne) {\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            for (Worker w : workers) {\n                Thread t = w.thread;\n                // \u8fd9\u91ccw.tryLock()\uff0c\u83b7\u53d6\u5230\u9501\u8bf4\u660e\u662f\u7a7a\u95f2\u7684\uff0c\u7a7a\u95f2\u7684\u624d\u8c03\u7528t.interrupt()\n                if (!t.isInterrupted() && w.tryLock()) {\n                    try {\n                        t.interrupt();\n                    } catch (SecurityException ignore) {\n                    } finally {\n                        w.unlock();\n                    }\n                }\n                if (onlyOne)\n                    break;\n            }\n        } finally {\n            mainLock.unlock();\n        }\n    }\n    // \u76f4\u63a5\u4e2d\u65ad\u6240\u6709\u542f\u52a8\u7684\u7ebf\u7a0b\n    private void interruptWorkers() {\n        // assert mainLock.isHeldByCurrentThread();\n        for (Worker w : workers)\n            w.interruptIfStarted();\n    }\n    // worker\u4e2d\u7684\u65b9\u6cd5\n    void interruptIfStarted() {\n            Thread t;\n            if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {\n                try {\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                }\n            }\n     }\n"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u7a7a\u95f2\u7684\u7ebf\u7a0b\u901a\u5e38\u5904\u4e8e\u4e00\u79cd\u53ef\u4e2d\u65ad\u7684\u963b\u585e\u72b6\u6001\u3002\u5728 ",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"})," \u4e2d\uff0c\u5f53\u7ebf\u7a0b\u6ca1\u6709\u4efb\u52a1\u53ef\u6267\u884c\u65f6\uff0c\u5927\u6982\u6709\u4e24\u79cd\u60c5\u51b5\uff1a"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u7b49\u5f85\u4efb\u52a1\uff08\u963b\u585e\u5728\u4efb\u52a1\u961f\u5217\u4e0a\uff09\uff1a\u7ebf\u7a0b\u5b8c\u6210\u4e86\u5f53\u524d\u4efb\u52a1\uff0c\u800c\u4efb\u52a1\u961f\u5217\u4e2d\u6ca1\u6709\u65b0\u7684\u4efb\u52a1\u65f6\uff0c\u4ece\u4efb\u52a1\u961f\u5217\u4e2d\u83b7\u53d6\u4e0b\u4e00\u4e2a\u4efb\u52a1\u3002\u5982\u679c\u4efb\u52a1\u961f\u5217\u4e3a\u7a7a\uff0c\u7ebf\u7a0b\u5c31\u4f1a\u963b\u585e\u5728 ",(0,t.jsx)(n.code,{children:"BlockingQueue.take()"})," \u6216 ",(0,t.jsx)(n.code,{children:"BlockingQueue.poll(long timeout, TimeUnit unit)"})," \u8fd9\u6837\u7684\u64cd\u4f5c\u4e0a"]}),"\n",(0,t.jsxs)(n.li,{children:["\u7b49\u5f85\u5176\u4ed6\u64cd\u4f5c\uff1a\u7ebf\u7a0b\u6c60\u4e2d\u7ebf\u7a0b\u6709\u65f6\u4f1a\u7b49\u5f85\u67d0\u4e9b\u7279\u5b9a\u7684\u4e8b\u4ef6\u6216\u4fe1\u53f7\uff0c\u4f8b\u5982\u7b49\u5f85\u7ebf\u7a0b\u6c60\u5173\u95ed\u4fe1\u53f7\u3002\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7ebf\u7a0b\u901a\u5e38\u4e5f\u4f1a\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"Object.wait()"}),"\u3001",(0,t.jsx)(n.code,{children:"Condition.await()"})," \u6216\u7c7b\u4f3c\u7684\u673a\u5236\u8fdb\u5165\u963b\u585e\u72b6\u6001\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u540c\u6837\u662f\u53ef\u4e2d\u65ad\u7684\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u540c\u65f6",(0,t.jsx)(n.code,{children:"shutdownNow"})," \u548c",(0,t.jsx)(n.code,{children:"shutdown"}),"\u65b9\u6cd5\u90fd\u662f\u6267\u884c",(0,t.jsx)(n.code,{children:"tryTerminate()"}),"\u65b9\u6cd5\uff0c",(0,t.jsx)(n.code,{children:"tryTerminate"}),"\u4e0d\u4f1a\u5f3a\u884c\u7ec8\u6b62\u7ebf\u7a0b\u6c60\uff0c\u53ea\u662f\u505a\u4e86\u4e00\u4e0b\u68c0\u6d4b\uff1a\u5f53",(0,t.jsx)(n.code,{children:"workerCount"}),"\u4e3a0\uff0c",(0,t.jsx)(n.code,{children:"workerQueue"}),"\u4e3a\u7a7a\u65f6\uff0c\u5148\u628a\u72b6\u6001\u5207\u6362\u5230",(0,t.jsx)(n.code,{children:"TIDYING"}),"\uff0c\u7136\u540e\u8c03\u7528\u94a9\u5b50\u51fd\u6570",(0,t.jsx)(n.code,{children:"terminated()"}),"\u3002\u5f53\u94a9\u5b50\u51fd\u6570\u6267\u884c\u5b8c\u6210\u65f6\uff0c\u628a\u72b6\u6001\u4ece ",(0,t.jsx)(n.code,{children:"TIDYING"})," \u6539\u4e3a ",(0,t.jsx)(n.code,{children:"TERMINATED"}),"\uff0c\u63a5\u7740\u8c03\u7528",(0,t.jsx)(n.code,{children:"termination.sinaglAll()"}),"\uff0c\u901a\u77e5\u524d\u9762\u963b\u585e\u5728",(0,t.jsx)(n.code,{children:"awaitTermination"}),"\u7684\u6240\u6709\u8c03\u7528\u8005\u7ebf\u7a0b\u3002"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"\u8fd9\u91cc\u4ee3\u7801\u6211\u5c31\u4e0d\u8d34\u4e86"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TIDYING"}),"\u548c",(0,t.jsx)(n.code,{children:"TREMINATED"}),"\u7684\u533a\u522b\u662f\u5728\u4e8c\u8005\u4e4b\u95f4\u6267\u884c\u4e86\u4e00\u4e2a\u94a9\u5b50\u51fd\u6570",(0,t.jsx)(n.code,{children:"terminated()"}),"\u662f\u4e00\u4e2a",(0,t.jsx)(n.code,{children:"protected"}),"\u7684\u7a7a\u5b9e\u73b0\uff0c\u9700\u8981\u5b50\u7c7b\u53bb\u81ea\u5b9a\u4e49\u5b9e\u73b0\u3002"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u4e5f\u5c31\u662f\u5728\u961f\u5217\u4e3a\u7a7a\uff0c\u7ebf\u7a0b\u6c60\u4e5f\u4e3a\u7a7a\u4e4b\u540e\uff0c\u8fdb\u5165",(0,t.jsx)(n.code,{children:"TIDYING"})," \u72b6\u6001\uff0c\u6700\u540e\u6267\u884c\u4e00\u4e2a\u94a9\u5b50\u51fd\u6570",(0,t.jsx)(n.code,{children:"terminated()"}),"\uff0c\u8fdb\u5165",(0,t.jsx)(n.code,{children:"TERMINATED"}),"\u72b6\u6001\u7ebf\u7a0b\u6c60\u624d\u7b97\u7ed3\u675f\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u5982\u4e0b\u662f\u4e00\u4e2a\u4f18\u96c5\u505c\u6b62\u7ebf\u7a0b\u6c60\u7684\u4f8b\u5b50\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"executor.shutdown();//\u6216\u8005\nexecutor.shuwdownNow();\n//\u8c03\u5b8c\u4e0a\u9762\u7684\u64cd\u4f5c\u4e4b\u540e\uff0c\u518d\u5faa\u73af\u8c03\u7528 awaitrermination\uff0c\u7b49\u5f85\u7ebf\u7a0b\u6c60\u771f\u6b63\u7ec8\u6b62\ntry {\n    boolean loop = true;\n    do{ //\u7b49\u5f85\u6240\u6709\u4efb\u52a1\u5b8c\u6210\n        loop = !executor.awaitTermination(2, TimeUnit.SECONDS);\n        //\u963b\u585e\uff0c\u76f4\u5230\u7ebf\u7a0b\u6c60\u91cc\u6240\u6709\u4efb\u52a1\u7ed3\u675f\n    }while (loop) ;\n} catch (InterruptedException e) {\n  ...\n\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"awaitTermination"}),"\u6e90\u7801\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// awaitTermination\u65b9\u6cd5\uff0c\u4e0d\u65ad\u5faa\u73af\u5224\u65ad\u7ebf\u7a0b\u6c60\u662f\u5426\u5230\u8fbe\u4e86\u6700\u7ec8\u72b6\u6001TERMINATED\uff0c\u5982\u679c\u662f\uff0c\u5c31\u8fd4\u56de;\u5982\u679c\u4e0d\u662f\uff0c\u5219\u901a\u8fc7termination\u6761\u4ef6\u53d8\u91cf\u963b\u585e\u4e00\u6bb5\u65f6\u95f4\uff0c\u82cf\u9192\u4e4b\u540e\uff0c\u7ee7\u7eed\u5224\u65ad\u3002\npublic boolean awaitTermination(long timeout, TimeUnit unit)\n        throws InterruptedException {\n        long nanos = unit.toNanos(timeout);\n        final ReentrantLock mainLock = this.mainLock;\n        mainLock.lock();\n        try {\n            while (runStateLessThan(ctl.get(), TERMINATED)) {\n                if (nanos <= 0L)\n                    return false;\n                nanos = termination.awaitNanos(nanos);\n            }\n            return true;\n        } finally {\n            mainLock.unlock();\n        }\n    }\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u7efc\u4e0a\u53ef\u4ee5\u770b\u5230\u7ebf\u7a0b\u6c60\u5728\u5173\u95ed\u8fc7\u7a0b\u4f1a\u51fa\u73b0\u7684\u60c5\u51b5\uff1a"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"shutdown"}),"\u7684\u7ebf\u7a0b\u6c60\u5173\u95ed\u8fc7\u7a0b"]})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u628a\u4efb\u52a1\u7684\u6267\u884c\u8fc7\u7a0b\u548c\u4e0a\u9762\u7684\u7ebf\u7a0b\u6c60\u7684\u5173\u95ed\u8fc7\u7a0b\u7ed3\u5408\u8d77\u6765\u8fdb\u884c\u5206\u6790\uff0c\u5f53\u8c03\u7528",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u51fa\u73b0\u4ee5\u4e0b\u51e0\u79cd\u573a\u666f\uff1a"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u573a\u666f1\uff1a\u5f53\u8c03\u7528",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u7684\u65f6\u5019\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u3002\u8fd9\u610f\u5473\u7740\u4efb\u52a1\u961f\u5217\u4e00\u5b9a\u662f\u7a7a\u7684\u3002\u6b64\u65f6\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u4f1a\u963b\u585e\u5728",(0,t.jsx)(n.code,{children:"getTask()"}),"\u51fd\u6570\u7684\u5730\u65b9\u3002\u7136\u540e\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u4f1a\u6536\u5230",(0,t.jsx)(n.code,{children:"interruptIdleWorkers()"}),"\u53d1\u6765\u7684\u4e2d\u65ad\u4fe1\u53f7\uff0c",(0,t.jsx)(n.code,{children:"getTask()"}),"\u8fd4\u56denull\uff0c\u6240\u6709Worker\u90fd\u4f1a\u9000\u51fawhile\u5faa\u73af\uff0c\u4e4b\u540e\u6267\u884c",(0,t.jsx)(n.code,{children:"processWorkerExit"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u573a\u666f2\uff1a\u5f53\u8c03\u7528",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u7684\u65f6\u5019\uff0c\u6240\u6709\u7ebf\u7a0b\u90fd\u5904\u4e8e\u5fd9\u788c\u72b6\u6001\u3002\u6b64\u65f6\uff0c\u961f\u5217\u53ef\u80fd\u662f\u7a7a\u7684\uff0c\u4e5f\u53ef\u80fd\u662f\u975e\u7a7a\u7684\u3002",(0,t.jsx)(n.code,{children:"interruptIdleWorkers()"}),"\u5185\u90e8\u7684",(0,t.jsx)(n.code,{children:"tryLock"}),"\u8c03\u7528\u5931\u8d25\uff0c\u4ec0\u4e48\u90fd\u4e0d\u4f1a\u505a\uff0c\u6240\u6709\u7ebf\u7a0b\u4f1a\u7ee7\u7eed\u6267\u884c\u81ea\u5df1\u5f53\u524d\u7684\u4efb\u52a1\u3002\u4e4b\u540e\u6240\u6709\u7ebf\u7a0b\u4f1a\u6267\u884c\u5b8c\u961f\u5217\u4e2d\u7684\u4efb\u52a1\uff0c\u76f4\u5230\u961f\u5217\u7a7a\uff0c",(0,t.jsx)(n.code,{children:"getTask()"}),"\u624d\u4f1a\u8fd4\u56denull\u3002\u4e4b\u540e\uff0c\u5c31\u548c\u573a\u666f1\u4e00\u6837\u4e86\uff0c\u9000\u51fawhile\u5faa\u73af\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u573a\u666f3\uff1a\u5f53\u8c03\u7528",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u7684\u65f6\u5019\uff0c\u90e8\u5206\u7ebf\u7a0b\u5fd9\u788c\uff0c\u90e8\u5206\u7ebf\u7a0b\u7a7a\u95f2\u3002\u6709\u90e8\u5206\u7ebf\u7a0b\u7a7a\u95f2\uff0c\u8bf4\u660e\u961f\u5217\u4e00\u5b9a\u662f\u7a7a\u7684\uff0c\u8fd9\u4e9b\u7ebf\u7a0b\u80af\u5b9a\u963b\u585e\u5728 ",(0,t.jsx)(n.code,{children:"getTask()"}),"\u51fd\u6570\u7684\u5730\u65b9\u3002\u7a7a\u95f2\u7684\u8fd9\u4e9b\u7ebf\u7a0b\u4f1a\u548c\u573a\u666f1\u4e00\u6837\u5904\u7406\uff0c\u4e0d\u7a7a\u95f2 \u7684\u7ebf\u7a0b\u4f1a\u548c\u573a\u666f2\u4e00\u6837\u5904\u7406"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"shutdownNow"}),"\u7684\u7ebf\u7a0b\u6c60\u5173\u95ed\u8fc7\u7a0b"]})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u548c\u4e0a\u9762\u7684",(0,t.jsx)(n.code,{children:"shutdown()"}),"\u7c7b\u4f3c\uff0c\u53ea\u662f\u591a\u4e86\u4e00\u4e2a\u73af\u8282\uff0c\u5373\u6e05\u7a7a\u4efb\u52a1\u961f\u5217\uff0c\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u6b63\u5728\u6267\u884c\u67d0\u4e2a\u4e1a\u52a1\u4ee3\u7801\uff0c\u5373\u4f7f \u5411\u5b83\u53d1\u9001\u4e2d\u65ad\u4fe1\u53f7\uff0c\u4e5f\u6ca1\u6709\u7528\uff0c\u53ea\u80fd\u7b49\u5b83\u628a\u4ee3\u7801\u6267\u884c\u5b8c\u6210\u3002\u4ece\u8fd9\u4e2a\u610f\u4e49\u4e0a\u8bb2\uff0c\u4e2d\u65ad\u7a7a\u95f2\u7ebf\u7a0b\u548c\u4e2d\u65ad\u6240\u6709\u7ebf\u7a0b\u7684\u533a\u522b\u5e76\u4e0d\u662f\u5f88\u5927\uff0c\u9664\u975e\u7ebf\u7a0b\u5f53\u524d\u521a\u597d\u963b\u585e\u5728\u67d0\u4e2a\u5730\u65b9\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"scheduledthreadpoolexecutor",children:"ScheduledThreadPoolExecutor"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"}),"\u5b9e\u73b0\u4e86",(0,t.jsx)(n.code,{children:"ScheduledExecutorService"}),"\u63a5\u53e3\uff0c\u8fd9\u4e2a\u63a5\u53e3\u5b9a\u4e49\u4e86\u6309\u65f6\u95f4\u8c03\u5ea6\u6765\u6267\u884c\u4efb\u52a1\u7684\u65b9\u6cd5\uff0c\u63a5\u53e3\u5b9a\u4e49\u4e864\u4e2a\u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u4e24\u4e2a\u5ef6\u8fdf\u6267\u884c\u7684\u4e00\u6b21\u6027\u4efb\u52a1\n// \u4e0d\u5e26\u8fd4\u56de\u503c\npublic ScheduledFuture<?> schedule(Runnable command,\n                                       long delay, TimeUnit unit);\n// \u5e26\u8fd4\u56de\u503c\npublic <V> ScheduledFuture<V> schedule(Callable<V> callable,\n                                           long delay, TimeUnit unit);\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u4e24\u4e2a\u5468\u671f\u6027\u6267\u884c\u7684\u4efb\u52a1\n/**\n * Submits a periodic action that becomes enabled first after the given initial delay, and subsequently with the given period; that is, executions will commence after initialDelay, then initialDelay + period, then initialDelay + 2 * period, and so on.\n * The sequence of task executions continues indefinitely until one of the following           exceptional completions occur:\n * // \u7136\u540e\u662f\u4e09\u79cd\u5468\u671f\u6027\u4efb\u52a1\u7ed3\u675f\u7684\u60c5\u51b5\n * The task is explicitly cancelled via the returned future.\n * The executor terminates, also resulting in task cancellation.\n * An execution of the task throws an exception. In this case calling get on the returned future will throw ExecutionException, holding the exception as its cause.\n */\npublic ScheduledFuture<?> scheduleAtFixedRate(Runnable command,\n                                                  long initialDelay,\n                                                  long period,\n                                                  TimeUnit unit);\n\n/**\n * Submits a periodic action that becomes enabled first after the given initial delay, and subsequently with the given delay between the termination of one execution and the commencement of the next.\n */\npublic ScheduledFuture<?> scheduleWithFixedDelay(Runnable command,\n                                                     long initialDelay,\n                                                     long delay,\n                                                     TimeUnit unit);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5176\u5b9e\u6e90\u7801\u4e2d\u7684\u63cf\u8ff0\u5df2\u7ecf\u662f\u5199\u7684\u975e\u5e38\u6e05\u695a\u4e86\uff0c\u603b\u7ed3\u4e00\u4e0b\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"AtFixedRate"}),":\u6309\u56fa\u5b9a\u9891\u7387\u6267\u884c\uff0c\u4e0e\u4efb\u52a1\u672c\u8eab\u6267\u884c\u65f6\u95f4\u65e0\u5173\u3002\u4f46\u6709 \u4e2a\u524d\u63d0\u6761\u4ef6\uff0c\u4efb\u52a1\u6267\u884c\u65f6\u95f4\u5fc5\u987b\u5c0f\u4e8e\u95f4\u9694\u65f6\u95f4\uff0c\u4f8b\u5982\u95f4\u9694\u65f6\u95f4\u662f5s\uff0c \u6bcf5s\u6267\u884c\u4e00\u6b21\u4efb\u52a1\uff0c\u4efb\u52a1\u7684\u6267\u884c\u65f6\u95f4\u5fc5\u987b\u5c0f\u4e8e5s\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"WithFixedDelay"}),":\u6309\u56fa\u5b9a\u95f4\u9694\u6267\u884c\uff0c\u4e0e\u4efb\u52a1\u672c\u8eab\u6267\u884c\u65f6\u95f4\u6709\u5173\u3002 \u4f8b\u5982\uff0c\u4efb\u52a1\u672c\u8eab\u6267\u884c\u65f6\u95f4\u662f10s\uff0c\u95f4\u96942s\uff0c\u5219\u4e0b\u4e00\u6b21\u5f00\u59cb\u6267\u884c\u7684\u65f6\u95f4\u5c31 \u662f12s\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"\u5185\u90e8\u5b9e\u73b0",children:"\u5185\u90e8\u5b9e\u73b0"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsxs)(n.em,{children:["\u7b80\u5355\u6765\u8bf4\u5c31\u662f\uff1a",(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"}),"\u7684\u5b9e\u73b0\u539f\u7406\u5c31\u662f\u5176\u7ee7\u627f",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"}),"\u5e76\u5728\u5185\u90e8\u7ef4\u62a4\u4e00\u4e2a",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"}),"\uff0c\u7136\u540e",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"}),"\u662f\u6309\u5ef6\u8fdf\u65f6\u95f4\u6392\u5e8f\u7684\u6700\u5c0f\u4e8c\u53c9\u5806\uff0c\u5ef6\u8fdf\u6267\u884c\u5c31\u662f\u963b\u585e\u7684\u53d6\u961f\u9876\u4efb\u52a1\uff0c\u800c\u5468\u671f\u6267\u884c\u5c31\u662f\u5728\u4e0a\u4e00\u4e2a\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u4e4b\u540e\u518d\u89c1\u4e00\u4e2a\u5ef6\u8fdf\u4efb\u52a1\uff0c\u540c\u65f6",(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"}),"\u6784\u9020\u51fd\u6570\u90fd\u662f\u4f7f\u7528\u7684",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"}),"\u6784\u9020\u51fd\u6570\uff0c\u53ea\u662f\u6ca1\u6709\u9650\u5236\u961f\u5217\u5927\u5c0f\u548c\u7ebf\u7a0b\u6c60\u7ebf\u7a0b\u6570\u91cf"]}),"\u3002"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u5b9e\u73b0\u7ec6\u8282"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class ScheduledThreadPoolExecutor\n        extends ThreadPoolExecutor\n        implements ScheduledExecutorService {\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u6784\u9020\u51fd\u6570\u4e0e\u914d\u7f6e"}),"\uff1a"]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"})," \u7684\u6784\u9020\u51fd\u6570\u4f7f\u7528\u4e86 ",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"})," \u7684\u6784\u9020\u51fd\u6570\u6765\u914d\u7f6e\u7ebf\u7a0b\u6c60\u7684\u6838\u5fc3\u7ebf\u7a0b\u6570\u548c\u7ebf\u7a0b\u5de5\u5382\u7b49\u5c5e\u6027\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u4e0e ",(0,t.jsx)(n.code,{children:"ThreadPoolExecutor"})," \u4e0d\u540c\uff0c",(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"})," \u6ca1\u6709\u786c\u6027\u9650\u5236\u7ebf\u7a0b\u6c60\u7684\u6700\u5927\u7ebf\u7a0b\u6570\u91cf\u548c\u961f\u5217\u5927\u5c0f\uff0c\u56e0\u4e3a\u5176\u4e3b\u8981\u76ee\u7684\u662f\u8c03\u5ea6\u4efb\u52a1\u3002\u5373\u4f7f ",(0,t.jsx)(n.code,{children:"maximumPoolSize"})," \u88ab\u8bbe\u7f6e\u8f83\u5c0f\uff0c\u7ebf\u7a0b\u6c60\u4e5f\u4f1a\u59cb\u7ec8\u5141\u8bb8\u521b\u5efa\u65b0\u7684\u7ebf\u7a0b\u6765\u6267\u884c\u8c03\u5ea6\u4efb\u52a1\uff0c\u4ee5\u786e\u4fdd\u5468\u671f\u6027\u4efb\u52a1\u53ef\u4ee5\u6309\u65f6\u6267\u884c\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public ScheduledThreadPoolExecutor(int corePoolSize,\n                                       ThreadFactory threadFactory,\n                                       RejectedExecutionHandler handler) {\n        // super\u5c31\u662fThreadPoolExecutor\u7684\u6784\u9020\u51fd\u6570\n        super(corePoolSize, Integer.MAX_VALUE,\n              DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,\n              new DelayedWorkQueue(), threadFactory, handler);\n    }\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"DelayedWorkQueue"}),"\uff1a"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ScheduledThreadPoolExecutor"})," \u5185\u90e8\u7ef4\u62a4\u4e86\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"}),"\uff0c\u7528\u4e8e\u5b58\u50a8\u548c\u7ba1\u7406\u6240\u6709\u7684\u8c03\u5ea6\u4efb\u52a1\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"DelayedWorkQueue"})," \u662f\u4e00\u4e2a\u57fa\u4e8e\u65f6\u95f4\u4f18\u5148\u7ea7\u7684\u963b\u585e\u961f\u5217\uff0c\u5b9e\u73b0\u4e86 ",(0,t.jsx)(n.code,{children:"BlockingQueue"})," \u63a5\u53e3\uff0c\u5e76\u901a\u8fc7\u5806\u7ed3\u6784\uff08\u5b9e\u9645\u4e0a\u662f",(0,t.jsx)(n.strong,{children:"\u6700\u5c0f\u5806"}),"\uff09\u6309\u4efb\u52a1\u7684\u5ef6\u8fdf\u65f6\u95f4\u8fdb\u884c\u6392\u5e8f\u3002\u961f\u5217\u5934\u90e8\u7684\u4efb\u52a1\u603b\u662f\u6700\u65e9\u9700\u8981\u6267\u884c\u7684\u4efb\u52a1\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"static class DelayedWorkQueue extends AbstractQueue<Runnable>\n        implements BlockingQueue<Runnable> {\n\n        /*\n         * A DelayedWorkQueue is based on a heap-based data structure\n         * like those in DelayQueue and PriorityQueue,\n         * ... \u6e90\u7801\u4e2d\u5bf9\u8fd9\u4e9b\u6570\u636e\u7ed3\u6784\u7684\u63cf\u8ff0\u5199\u7684\u975e\u5e38\u597d\uff0c\u6211\u5c31\u4e0d\u8d34\u4e86\uff0c\u592a\u957f\u4e86\n         */\n        private static final int INITIAL_CAPACITY = 16;\n        private RunnableScheduledFuture<?>[] queue =\n            new RunnableScheduledFuture<?>[INITIAL_CAPACITY];\n        private final ReentrantLock lock = new ReentrantLock();\n        private int size;\n\n        // \u7ef4\u62a4\u7684 Thread leader \u5b9e\u9645\u4e0a\u5c31\u662f\u9886\u5bfc\u8005/\u8ffd\u968f\u8005\uff08Leader-Follower\uff09\u6a21\u5f0f\uff0c\u4ee5\u51cf\u5c11\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u7ade\u4e89\u961f\u5217\u5934\u8282\u70b9\u7684\u5f00\u9500\u3002\n        private Thread leader;\n\n   /**\n     * \u5728 DelayedWorkQueue\u7684 add/offer\u5165\u961f\u548cpoll/take\u51fa\u961f\u65b9\u6cd5\u4e2d\u6709\u4e0b\u9762\u7684\u903b\u8f91\uff1a\n     * \u5f53\u591a\u4e2a\u7ebf\u7a0b\u5728 DelayedWorkQueue \u4e0a\u7b49\u5f85\u65f6\uff0c\u5176\u4e2d\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f1a\u6210\u4e3a\u5f53\u524d\u7684leader\uff0c\u8d1f\u8d23\u7b49\u5f85\u961f\u5217\u5934\u90e8\u4efb\u52a1\u7684\u5230\u671f\u65f6\u95f4\u3002\n     * \u8fd9\u4e2aleader\u7ebf\u7a0b\u4f7f\u7528 Condition.awaitNanos \u65b9\u6cd5\u7b49\u5f85\u5269\u4f59\u65f6\u95f4\uff08\u5373\u8ddd\u79bb\u961f\u5217\u5934\u90e8\u4efb\u52a1\u7684\u6267\u884c\u65f6\u95f4\uff09\uff0c\n     * \u5176\u4ed6\u975e leader \u7ebf\u7a0b\u5728\u5c1d\u8bd5\u83b7\u53d6\u4efb\u52a1\u65f6\uff0c\u5982\u679c\u53d1\u73b0\u6709 leader \u6b63\u5728\u7b49\u5f85\uff0c\u5219\u4f1a\u8fdb\u5165 Condition.await \u72b6\u6001\uff0c\u8fd9\u6837\u5b83\u4eec\u4e0d\u4f1a\u540c\u65f6\u7ade\u4e89\u83b7\u53d6\u4efb\u52a1\u3002\n     * \u53ea\u6709\u5f53 leader \u7ebf\u7a0b\u88ab\u5524\u9192\u65f6\uff0c\u5b83\u4f1a\u68c0\u67e5\u4efb\u52a1\u662f\u5426\u5230\u671f\u3002\u5982\u679c\u4efb\u52a1\u5230\u671f\uff0c\u5b83\u5c06\u4efb\u52a1\u51fa\u961f\uff0c\u5426\u5219\u5b83\u4f1a\u518d\u6b21\u7b49\u5f85\uff0c\u5e76\u7ee7\u7eed\u5145\u5f53 leader\u3002\n     * \u5982\u679c leader \u7ebf\u7a0b\u5b8c\u6210\u4e86\u4efb\u52a1\u83b7\u53d6\u6216\u5176\u4ed6\u5de5\u4f5c\uff0c\u4f1a\u5c06 leader \u8bbe\u7f6e\u4e3a null\uff0c\u4ee5\u4fbf\u5176\u4ed6\u7b49\u5f85\u7ebf\u7a0b\u4e2d\u7684\u4e00\u4e2a\u53ef\u4ee5\u6210\u4e3a\u65b0\u7684 leader\u3002\n     *  \u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f1a\u5904\u4e8e\u6d3b\u8dc3\u7b49\u5f85\u72b6\u6001\uff0c\u5176\u4f59\u7ebf\u7a0b\u5219\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\uff0c\u51cf\u5c11\u4e86\u591a\u7ebf\u7a0b\u95f4\u7684\u7ade\u4e89\u9501\u548c\u4e0a\u4e0b\u6587\u5207\u6362\u7684\u5f00\u9500\n     */\n        private final Condition available = lock.newCondition();\n  ...\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u5ef6\u8fdf\u4efb\u52a1\u7684\u8c03\u5ea6"}),"\uff1a"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5f53\u63d0\u4ea4\u4e00\u4e2a\u5ef6\u8fdf\u4efb\u52a1\u65f6\uff08\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"schedule"})," \u65b9\u6cd5\uff09\uff0c\u4efb\u52a1\u4f1a\u88ab\u5305\u88c5\u4e3a ",(0,t.jsx)(n.code,{children:"ScheduledFutureTask"})," \u5e76\u63d2\u5165\u5230 ",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"})," \u4e2d\u3002\u800c",(0,t.jsx)(n.code,{children:"ScheduledFutureTask"})," \u5b9e\u73b0\u4e86 ",(0,t.jsx)(n.code,{children:"RunnableScheduledFuture"})," \u63a5\u53e3\uff0c\u540c\u65f6\u5177\u5907 ",(0,t.jsx)(n.code,{children:"Runnable"})," \u548c ",(0,t.jsx)(n.code,{children:"ScheduledFuture"})," \u7684\u529f\u80fd\uff0c\u7528\u4e8e\u5904\u7406\u8c03\u5ea6\u903b\u8f91\u3002\u7ebf\u7a0b\u6c60\u4e2d\u7684\u5de5\u4f5c\u7ebf\u7a0b\u4f1a\u5c1d\u8bd5\u4ece ",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"})," \u83b7\u53d6\u4efb\u52a1\u3002\u5982\u679c\u961f\u5217\u5934\u90e8\u7684\u4efb\u52a1\u5c1a\u672a\u5230\u8fbe\u5176\u6267\u884c\u65f6\u95f4\uff0c\u5de5\u4f5c\u7ebf\u7a0b\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u4efb\u52a1\u51c6\u5907\u597d\u6267\u884c\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"private class ScheduledFutureTask<V>\n            extends FutureTask<V> implements RunnableScheduledFuture<V> {\n\n        /** Sequence number to break ties FIFO */\n        private final long sequenceNumber;\n\n        /** The nanoTime-based time when the task is enabled to execute. */\n        private volatile long time;\n\n        /**\n         * Period for repeating tasks, in nanoseconds.\n         * A positive value indicates fixed-rate execution.\n         * A negative value indicates fixed-delay execution.\n         * A value of 0 indicates a non-repeating (one-shot) task.\n         */\n        private final long period;\n  ...\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u5468\u671f\u6027\u4efb\u52a1\u7684\u8c03\u5ea6"}),"\uff1a"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5468\u671f\u6027\u4efb\u52a1\uff08\u5982\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"scheduleAtFixedRate"})," \u548c ",(0,t.jsx)(n.code,{children:"scheduleWithFixedDelay"})," \u63d0\u4ea4\u7684\u4efb\u52a1\uff09\u5728\u6267\u884c\u5b8c\u6210\u540e\uff0c\u4f1a\u81ea\u52a8\u91cd\u65b0\u5b89\u6392\u4e0b\u4e00\u4e2a\u6267\u884c\u65f6\u95f4\uff0c\u5e76\u518d\u6b21\u63d2\u5165\u5230 ",(0,t.jsx)(n.code,{children:"DelayedWorkQueue"})," \u4e2d\u3002"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"scheduleAtFixedRate"}),"\uff1a\u65b0\u4efb\u52a1\u7684\u6267\u884c\u65f6\u95f4\u662f\u57fa\u4e8e\u56fa\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u4ece\u4e0a\u4e00\u4e2a\u4efb\u52a1\u5f00\u59cb\u6267\u884c\u7684\u65f6\u95f4\u70b9\u8ba1\u7b97\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"scheduleWithFixedDelay"}),"\uff1a\u65b0\u4efb\u52a1\u7684\u6267\u884c\u65f6\u95f4\u662f\u57fa\u4e8e\u4e0a\u4e00\u4e2a\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u540e\u7684\u56fa\u5b9a\u5ef6\u8fdf\u65f6\u95f4\u8ba1\u7b97\u3002"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var t=r(6540);const i={},l=t.createContext(i);function o(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);